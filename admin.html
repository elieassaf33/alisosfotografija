<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Upload - Alisos Fotografija</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 20px; }
        label, input, button { display: block; margin: 10px 0; }
        button { padding: 10px 20px; cursor: pointer; }
        #status, #uploadStatus { margin-top: 15px; font-weight: bold; }
        #upload-section { display: none; margin-top: 20px; }
        #photos-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
        }
        .photo-card { 
            border: 1px solid #ddd; 
            padding: 10px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .photo-card img { width: 100%; border-radius: 8px; margin-bottom: 10px; }
        .delete-btn { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .delete-btn:hover { background: #c0392b; }
    </style>
</head>
<body>
    <h1>Admin Login</h1>

    <div id="login-section">
        <label for="email">Email:</label>
        <input type="email" id="email" placeholder="Enter admin email">
        <label for="password">Password:</label>
        <input type="password" id="password" placeholder="Enter password">
        <button id="loginBtn">Login</button>
        <div id="status"></div>
    </div>

    <div id="upload-section">
        <h2>Upload Image</h2>
        <label for="fileInput">Choose Image:</label>
        <input type="file" id="fileInput">

        <label for="category">Select Category:</label>
        <select id="category">
            <option value="studio">Studija</option>
            <option value="family">Å eima</option>
            <option value="portrait">Portretai</option>
            <option value="events">Renginiai</option>
        </select>

        <button id="uploadBtn">Upload</button>
        <div id="uploadStatus"></div>
        <h2>Add Review</h2>
        <label for="reviewer">Name:</label>
        <input type="text" id="reviewer" placeholder="Reviewer name">

        <label for="reviewText">Review:</label>
        <textarea id="reviewText" placeholder="Write the review..." rows="4"></textarea>

        <label for="rating">Rating (1-5):</label>
        <input type="number" id="rating" min="1" max="5">

        <button id="addReviewBtn">Add Review</button>
        <div id="reviewStatus"></div>

        <hr>
        <h2>Manage Photos</h2>
        <button id="loadPhotosBtn">Load Photos</button>
        <div id="photos-container"></div>
        
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC6P-2nngV7gL7f7UeJICkJ_uwOikFFK50",
            authDomain: "alisos-fotografija.firebaseapp.com",
            projectId: "alisos-fotografija",
            storageBucket: "alisos-fotografija.appspot.com",
            messagingSenderId: "394303533680",
            appId: "1:394303533680:web:8839ce95758766463c7ab5",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        const loginBtn = document.getElementById('loginBtn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const statusDiv = document.getElementById('status');
        const uploadSection = document.getElementById('upload-section');

        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const categorySelect = document.getElementById('category');
        const uploadStatus = document.getElementById('uploadStatus');

        const loadPhotosBtn = document.getElementById('loadPhotosBtn');
        const photosContainer = document.getElementById('photos-container');

        // Replace with your actual Admin UID
        const ADMIN_UID = "BfeIB1JrBYM1kU4QSW9K8zWDNNP2";

        // Login functionality
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                if (user.uid !== ADMIN_UID) {
                    statusDiv.textContent = "Not authorized!";
                    await auth.signOut();
                    return;
                }

                statusDiv.textContent = "Login successful!";
                document.getElementById('login-section').style.display = 'none';
                uploadSection.style.display = 'block';

            } catch (error) {
                console.error(error);
                statusDiv.textContent = "Login failed. Check credentials.";
            }
        });

        // Upload functionality
        uploadBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    const category = categorySelect.value;
    if (!file) return alert('Select a file!');

    uploadStatus.textContent = 'Preparing image...';

    // Function to compress/resize the image
    const compressImage = (file, maxWidth = 1024, maxHeight = 1024, quality = 0.8) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                let width = img.width;
                let height = img.height;

                // Maintain aspect ratio
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
            };
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    };

    // Function to compress until under max size
    const compressImageToMaxSize = async (file, maxSizeMB = 10) => {
        let quality = 0.8;
        let blob = await compressImage(file, 1024, 1024, quality);

        while (blob.size > maxSizeMB * 1024 * 1024 && quality > 0.3) {
            quality -= 0.05;
            blob = await compressImage(file, 1024, 1024, quality);
        }
        return blob;
    };

    try {
        let fileToUpload = file;

        // Compress only if over 10 MB
        if (file.size > 10 * 1024 * 1024) {
            uploadStatus.textContent = 'Compressing large file...';
            fileToUpload = await compressImageToMaxSize(file);
        }

        const formData = new FormData();
        formData.append('file', fileToUpload, file.name);
        formData.append('upload_preset', 'studio_upload');
        formData.append('folder', category);

        uploadStatus.textContent = 'Uploading to Cloudinary...';

        const response = await fetch('https://api.cloudinary.com/v1_1/dvwbgfsbg/upload', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        if (!data.secure_url) throw new Error('Upload failed');

        uploadStatus.textContent = 'Saving URL to Firestore...';

        await addDoc(collection(db, "photos"), {
            url: data.secure_url,
            category: category,
            caption: file.name,
            createdAt: serverTimestamp()
        });

        uploadStatus.textContent = 'Upload successful!';
        fileInput.value = '';
    } catch (error) {
        console.error(error);
        uploadStatus.textContent = 'Upload failed. Check console.';
    }
});

        // Load and display photos
        loadPhotosBtn.addEventListener('click', async () => {
            photosContainer.innerHTML = "Loading...";

            try {
                const snapshot = await getDocs(collection(db, "photos"));
                photosContainer.innerHTML = "";

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const card = document.createElement("div");
                    card.classList.add("photo-card");

                    const img = document.createElement("img");
                    img.src = data.url;
                    img.alt = data.caption || "photo";

                    const delBtn = document.createElement("button");
                    delBtn.textContent = "Delete";
                    delBtn.classList.add("delete-btn");
                    delBtn.addEventListener("click", async () => {
                        if (confirm("Delete this photo?")) {
                            try {
                                await deleteDoc(doc(db, "photos", docSnap.id));
                                card.remove();
                                alert("Photo deleted.");
                            } catch (err) {
                                console.error(err);
                                alert("Failed to delete.");
                            }
                        }
                    });

                    card.appendChild(img);
                    card.appendChild(delBtn);
                    photosContainer.appendChild(card);
                });

                if (!photosContainer.innerHTML) {
                    photosContainer.innerHTML = "<p>No photos found.</p>";
                }

            } catch (error) {
                console.error(error);
                photosContainer.innerHTML = "<p>Failed to load photos.</p>";
            }
        });
    const addReviewBtn = document.getElementById('addReviewBtn');
    const reviewerInput = document.getElementById('reviewer');
    const reviewTextInput = document.getElementById('reviewText');
    const ratingInput = document.getElementById('rating');
    const reviewStatus = document.getElementById('reviewStatus');

    addReviewBtn.addEventListener('click', async () => {
        const reviewer = reviewerInput.value.trim();
        const reviewText = reviewTextInput.value.trim();
        const rating = parseInt(ratingInput.value);

        if (!reviewer || !reviewText || !rating) {
            reviewStatus.textContent = "All fields are required!";
            return;
        }

        reviewStatus.textContent = "Saving review...";

        try {
            await addDoc(collection(db, "reviews"), {
                reviewer: reviewer,
                text: reviewText,
                rating: rating,
                createdAt: serverTimestamp()
            });

            reviewStatus.textContent = "Review added!";
            reviewerInput.value = "";
            reviewTextInput.value = "";
            ratingInput.value = "";

        } catch (error) {
            console.error(error);
            reviewStatus.textContent = "Failed to save review.";
        }
    });
    
    </script>
</body>
</html>
