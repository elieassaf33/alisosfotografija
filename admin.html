<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Upload - Alisos Fotografija</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 20px; }
        label, select, input, button { display: block; margin: 10px 0; }
        button { padding: 10px 20px; cursor: pointer; }
        #status { margin-top: 15px; font-weight: bold; }
        #photoList { margin-top: 30px; display: flex; flex-wrap: wrap; gap: 15px; }
        .photo-item { position: relative; width: 150px; height: 150px; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .deleteBtn { position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; padding: 5px 8px; cursor: pointer; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>
    <h1>Admin Panel</h1>

    <label for="category">Select Category:</label>
    <select id="category">
        <option value="portrait">Studija</option>
        <option value="family">Å eima</option>
        <option value="nature">Gamta</option>
        <option value="events">Renginiai</option>
    </select>

    <label for="fileInput">Choose Image to Upload:</label>
    <input type="file" id="fileInput">
    <button id="uploadBtn">Upload</button>
    <button id="loadBtn">Load Photos</button>

    <div id="status"></div>
    <h2>Existing Photos</h2>
    <div id="photoList"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC6P-2nngV7gL7f7UeJICkJ_uwOikFFK50",
            authDomain: "alisos-fotografija.firebaseapp.com",
            projectId: "alisos-fotografija",
            storageBucket: "alisos-fotografija.appspot.com",
            messagingSenderId: "394303533680",
            appId: "1:394303533680:web:8839ce95758766463c7ab5",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const uploadBtn = document.getElementById('uploadBtn');
        const loadBtn = document.getElementById('loadBtn');
        const fileInput = document.getElementById('fileInput');
        const categorySelect = document.getElementById('category');
        const statusDiv = document.getElementById('status');
        const photoList = document.getElementById('photoList');

        // Upload image
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            const category = categorySelect.value;
            if (!file) return alert('Select a file!');

            statusDiv.textContent = 'Uploading to Cloudinary...';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'studio_upload');
            formData.append('folder', category);

            try {
                const response = await fetch('https://api.cloudinary.com/v1_1/dvwbgfsbg/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (!data.secure_url) throw new Error(JSON.stringify(data));

                statusDiv.textContent = 'Saving URL to Firestore...';
                await addDoc(collection(db, "photos"), {
                    url: data.secure_url,
                    category: category,
                    caption: file.name,
                    publicId: data.public_id,
                    createdAt: serverTimestamp()
                });

                statusDiv.textContent = 'Upload successful!';
                fileInput.value = '';
                loadPhotos(category);
            } catch (err) {
                console.error(err);
                statusDiv.textContent = 'Upload failed. Check console.';
            }
        });

        // Load photos
        async function loadPhotos(category) {
            photoList.innerHTML = '';
            try {
                const q = query(
                    collection(db, "photos"),
                    where("category", "==", category),
                    orderBy("createdAt", "desc")
                );
                const snapshot = await getDocs(q);
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.dataset.id = docSnap.id;
                    div.dataset.publicId = data.publicId;
                    div.innerHTML = `
                        <img src="${data.url}" alt="${data.caption}">
                        <button class="deleteBtn">Delete</button>
                    `;
                    photoList.appendChild(div);

                    div.querySelector('.deleteBtn').addEventListener('click', () => deletePhoto(docSnap.id, div));
                });
            } catch (err) {
                console.error('Error loading photos:', err);
            }
        }

        // Delete photo
        async function deletePhoto(docId, element) {
            if (!confirm('Are you sure you want to delete this photo?')) return;
            try {
                await deleteDoc(doc(db, "photos", docId));
                element.remove();
                alert('Deleted successfully!');
            } catch (err) {
                console.error('Delete failed', err);
                alert('Delete failed. Check console.');
            }
        }

        // Load button click
        loadBtn.addEventListener('click', () => {
            const category = categorySelect.value;
            loadPhotos(category);
        });
    </script>
</body>
</html>
